<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>4</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Literata:ital,opsz,wght@0,7..72,200..900;1,7..72,200..900&family=Crimson+Text:ital,wght@0,400;0,600;1,400;1..600&display=swap" rel="stylesheet">
    
    <link rel="icon" href="favicon.ico">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon16.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon32.png">
    <link rel="apple-touch-icon" sizes="180x180" href="assets/favicons/apple.png">
    
    
    
    
    <style>
        /* === БАЗОВЫЕ СТИЛИ === */
              * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Literata', serif;
            background-color: #ffffff;
            color: #000000;
            line-height: 1.5;
            width: 100%;
            min-height: 100vh;
            overflow-x: auto;
        }

        .container {
            position: relative;
            margin: 0 auto;
            background-color: #ffffff;
            min-height: 100vh;
            padding: 1rem;
            max-width: 100%;
        }

        /* === ВЕРХНЯЯ НАВИГАЦИЯ === */
        .header-navigation {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
            margin-bottom: 1rem;
            padding: 0 1rem;
            position: fixed;
            top: 1rem;
            left: 0;
            gap: 1rem;
            z-index: 10;
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
        }

        .nav-back {
            font-family: 'Literata', serif;
            font-size: 1rem;
            line-height: 2.25rem;
            font-weight: 400;
            color: #000000;
            cursor: pointer;
            transition: opacity 0.3s ease;
            flex: 0 0 auto;
        }

        .nav-back:hover {
            opacity: 0.7;
        }

        /* Стили для кнопки с глазом */
        .nav-eye {
            font-family: 'Literata', serif;
            font-size: 1.5rem;
            line-height: 2.25rem;
            font-weight: 400;
            color: #000000;
            text-align: center;
            flex: 1;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .nav-eye:hover {
            opacity: 0.7;
        }

        .nav-about {
            font-family: 'Literata', serif;
            font-size: 0.8rem;
            line-height: 2.25rem;
            font-weight: 400;
            color: #000000;
            cursor: pointer;
            transition: opacity 0.3s ease;
            flex: 0 0 auto;
        }

        .nav-about:hover {
            opacity: 0.7;
        }

        /* === ОСНОВНАЯ ОБЛАСТЬ С ГРАФИКОЙ === */
        .main-content {
            position: relative;
            width: 100%;
            min-height: 500px;
            display: flex;
            justify-content: center;
            align-items: center;
            margin-top: 80px;
        }

        .canvas-container {
            position: relative;
            width: 100%;
            max-width: none;
            height: 100vh;
            aspect-ratio: none;
        }

        .graphic-canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: url('/Users/macbookpro/Desktop/sound-diary/assets/images/1.png');
            background-repeat: no-repeat;
            background-position: center;
            background-size: contain;
            transition: all 0.5s ease-in-out;
            z-index: 1;
        }

        #drawingCanvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            cursor: crosshair;
            z-index: 2;
        }

        .text-note {
            position: absolute;
            background: transparent;
            border: none;
            font-family: 'Literata', serif;
            font-size: 14px;
            color: #000000;
            resize: none;
            outline: none;
            z-index: 3;
            cursor: move;
            min-width: 100px;
            min-height: 20px;
        }

        .text-note:focus {
            cursor: text;
        }

        /* === ВСПЛЫВАЮЩАЯ КНОПКА ОПИСАНИЙ === */
        .descriptions-popup {
            position: fixed;
            bottom: 6rem;
            right: 2rem;
            z-index: 20;
            transition: all 0.3s ease;
        }

        .descriptions-toggle {
            background-color: #ffffff;
            border: 1.5px solid #000000;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            font-family: 'Literata', serif;
            font-size: 1.2rem;
            font-weight: 400;
            color: #000000;
            transition: all 0.3s ease;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .descriptions-toggle:hover {
            background-color: #f0f0f0;
            transform: scale(1.05);
        }

        .descriptions-toggle.active {
            background-color: #000000;
            color: #ffffff;
        }

        .descriptions-content {
            position: absolute;
            bottom: 60px;
            right: 0;
            width: min(90vw, 500px);
            max-height: min(60vh, 450px);
            background-color: #ffffff;
            border: 1.5px solid #000000;
            padding: 1.5rem;
            overflow-y: auto;
            display: none;
        }

        .descriptions-content.active {
            display: block;
        }

        .descriptions {
            grid-template-columns: 1fr;
            gap: 1.5rem;
            margin-right: 10%;
            margin-top: 12%;
        }

        .description-column {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }

        .description-item {
            display: flex;
            gap: 1rem;
            align-items: flex-start;
        }

        .description-number {
            font-family: 'Literata', serif;
            font-size: 1rem;
            font-weight: 400;
            min-width: 1.5rem;
            flex-shrink: 0;
        }

        .description-content {
            flex: 1;
        }

        .description-title {
            font-family: 'Crimson Text', serif;
            font-style: italic;
            font-size: 1rem;
            font-weight: 400;
            margin-bottom: 0.25rem;
            line-height: 1.3;
            text-align: justify;
        }

        .description-details {
            font-family: 'Literata', serif;
            font-size: 0.9rem;
            font-weight: 400;
            line-height: 1.4;
            color: #000000;
        }

        /* === ПАНЕЛЬ УПРАВЛЕНИЯ === */
        .control-panel {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 1rem;
            z-index: 10;
        }

        .control-icons {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            align-items: flex-end;
            font-size: 1.1rem;
            line-height: 1.82rem;
        }

        .coordinate-text {
            font-family: 'Literata', serif;
            font-size: 0.8rem;
            text-align: right;
            color: #000000;
            line-height: 1.3;
        }

        /* === МУЗЫКАЛЬНЫЙ CANVAS === */
        .music-canvas-container {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 4;
            pointer-events: none;
        }

        #musicCanvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: auto;
        }

        .music-track {
            position: absolute;
            padding: 0px 2px;
            white-space: nowrap;
            cursor: pointer;
            font-family: 'Literata', serif;
            pointer-events: auto;
            transition: all 0.3s ease;
        }

        .music-track:hover {
            color: black !important;
            transform: scale(1.05);
        }

        .music-track.playing {
            font-weight: bold;
            padding: 1px 2px;
            background: rgb(255, 255, 255);
            border-color: black;
            border-style: solid;
            border-width: 1px 1px 1px 8px;
            z-index: 1000;
        }

        .music-track.playing:before {
            content: "\266B";
            color: black;
            margin-right: 4px;
        }

        .full-width-description {
            margin-bottom: 40px;
            margin-top: 20px;
        }

        .description-spacer {
            height: 100px;
        }

        .two-columns-container {
            /* display: flex; */
            gap: 40px;
        }

        .description-column {
            flex: 1;
        }

        /* Адаптивность */
        @media (max-width: 768px) {
            .two-columns-container {
                flex-direction: column;
                gap: 20px;
            }
            
            .description-spacer {
                height: 30px;
            }
        }

        /* === АДАПТИВНЫЕ СТИЛИ === */

        /* Большие экраны (1200px+) */
        @media screen and (min-width: 1200px) {
            .descriptions {
                grid-template-columns: 1fr 1fr;
                gap: 2rem;
            }
            
            .container {
                padding: 2rem;
            }
        }

        /* Планшеты (768px - 1199px) */
        @media screen and (max-width: 1199px) {
            .main-content {
                margin-top: 70px;
            }
            
            .canvas-container {
                max-width: 90%;
            }
            
            .descriptions-content {
                width: 400px;
                max-height: 400px;
            }
        }

        /* Большие мобильные (601px - 767px) */
        @media screen and (max-width: 767px) {
            .header-navigation {
                padding: 0 0.5rem;
                gap: 0.5rem;
            }
            
            .nav-back {
                font-size: 0.9rem;
            }
            
            .nav-eye {
                font-size: 1.3rem;
            }
            
            .nav-about {
                font-size: 0.7rem;
            }
            
            .main-content {
                margin-top: 60px;
            }
            
            .canvas-container {
                max-width: 95%;
            }
            
            .descriptions-popup {
                bottom: 5rem;
                right: 1rem;
            }
            
            .descriptions-content {
                width: 350px;
                max-height: 350px;
                padding: 1rem;
            }
            
            .control-panel {
                bottom: 1rem;
                right: 1rem;
            }
            
            .coordinate-text {
                font-size: 0.7rem;
            }
        }

        /* Мобильные устройства (480px - 600px) */
        @media screen and (max-width: 600px) {
            .container {
                padding: 0.5rem;
            }
            
            .header-navigation {
                top: 0.5rem;
            }
            
            .main-content {
                margin-top: 50px;
            }
            
            .descriptions-toggle {
                width: 45px;
                height: 45px;
                font-size: 1.1rem;
            }
            
            .descriptions-content {
                width: 300px;
                max-height: 300px;
                bottom: 50px;
            }
            
            .descriptions {
                gap: 1rem;
            }
            
            .description-column {
                gap: 1rem;
            }
            
            .description-item {
                gap: 0.5rem;
            }
            
            .description-number {
                font-size: 0.9rem;
                min-width: 1.2rem;
            }
            
            .description-title {
                font-size: 0.9rem;
            }
            
            .description-details {
                font-size: 0.8rem;
            }
        }

        /* Маленькие мобильные (320px - 479px) */
        @media screen and (max-width: 479px) {
            .header-navigation {
                flex-wrap: wrap;
                padding: 0.5rem;
            }
            
            .nav-back, .nav-about {
                flex: 0 0 auto;
            }
            
            .nav-eye {
                flex: 0 0 100%;
                order: -1;
                margin-bottom: 0.5rem;
            }
            
            .main-content {
                margin-top: 80px;
            }
            
            .descriptions-popup {
                bottom: 4rem;
                right: 0.5rem;
            }
            
            .descriptions-content {
                width: 280px;
                max-height: 250px;
                right: -50px;
            }
            
            .control-panel {
                bottom: 0.5rem;
                right: 0.5rem;
            }
            
            .coordinate-text {
                font-size: 0.6rem;
                text-align: center;
            }
            
            .music-track {
                font-size: 0.9rem !important;
            }
        }

        /* Очень маленькие экраны (до 319px) */
        @media screen and (max-width: 319px) {
            .descriptions-content {
                width: 250px;
                max-height: 200px;
                padding: 0.8rem;
            }
            
            .description-item {
                flex-direction: column;
                gap: 0.25rem;
            }
            
            .description-number {
                min-width: auto;
            }
        }

        /* Альбомная ориентация на мобильных */
        @media screen and (max-height: 600px) and (orientation: landscape) {
            .main-content {
                margin-top: 50px;
            }
            
            .descriptions-content {
                max-height: 200px;
            }
            
            .header-navigation {
                padding: 0.25rem 0.5rem;
            }
        }

        /* Высокие экраны */
        @media screen and (min-height: 1000px) {
            .main-content {
                margin-top: 100px;
            }
            
            .canvas-container {
                max-width: 80%;
            }
        }

        /* Поддержка touch-устройств */
        @media (pointer: coarse) {
            .music-track {
                min-width: 44px;
                min-height: 44px;
                display: flex;
                align-items: center;
                justify-content: center;
            }
            
            .descriptions-toggle {
                min-width: 44px;
                min-height: 44px;
            }
            
            .nav-back, .nav-about {
                padding: 0.5rem;
                min-height: 44px;
                display: flex;
                align-items: center;
            }
        }
    </style>
</head>
<body>
    <div class="container" id="canvasContainer">
        <!-- Верхняя навигация -->
        <header class="header-navigation">
            <div class="nav-back" onclick="navigateToPage('map.html')">←</div>
            
            <div class="nav-about" onclick="navigateToPage('info.html')">О ПРОЕКТЕ</div>
        </header>

        <!-- Основная область с графическим элементом -->
        <main class="main-content">
            <div class="canvas-container">
                <div class="graphic-canvas" id="hiddenImage" style="display:none"></div>
                <canvas id="drawingCanvas"></canvas>
                
                <!-- Музыкальный canvas -->
                <div class="music-canvas-container">
                    <canvas id="musicCanvas"></canvas>
                </div>
            </div>
        </main>

        <!-- Всплывающая кнопка описаний -->

                        
        <div class="descriptions-popup">
            <div class="descriptions-toggle" id="descriptionsToggle" title="Описания работ">
                i
            </div>
            <div class="descriptions-content" id="descriptionsContent">
                <div class="descriptions">
                    <div class="description-fillwidth">
                        <!-- Полноширинное описание -->
                        <div class="full-width-description">
                            <div class="description-item">
                                <div class="description-number"></div>
                                <div class="description-content">
                                    <div class="description-title">
                                       Weird and wonderful and often surprising. <br> Exploration of electromagnetic fields and musical notes that draws inspiration from his formal training in biology. The tracks usually begin by me plugging the plant or fungi into a biodata device which converts small changes in conductivity into control voltage and gate information for a modular synthesizer. We then improvise in the moment with what comes up. </div>
                                </div>
                            </div>
                        </div>

                        <!-- Промежуток -->
                        <!-- <div class="description-spacer"></div> -->

                        <!-- Двухколоночный список -->
                        <div class="two-columns-container">
                            <!-- Левая колонка -->
                            <div class="description-column">
                               
                                <div class="description-item">
                                    <div class="description-number">1</div>
                                    <div class="description-content">
                                        <div class="description-title">Plant Music, Vol.1</div>
                                        <div class="description-details">2021<br>Modern biology</div>
                                    </div>
                                </div>
                                <div class="description-item">
                                    <div class="description-number">2</div>
                                    <div class="description-content">
                                        <div class="description-title">Mushrooms</div>
                                        <div class="description-details">2021<br>Modern biology</div>
                                    </div>
                                </div>

                            


                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Панель управления -->
        <div class="control-panel">
            <div class="control-icons">
                <div class="coordinate-text">SCALE YOUR SCREEN<br> FIND THE RIGHT DISTANCE<br> CTRL + S FOR SAVE</div>
            </div>
        </div>
    </div>


    <script>
        // Глобальные переменные для основного canvas
        let canvas, ctx;
        let currentTool = 'draw';
        let isDrawing = false;
        let startX, startY;
        let drawnObjects = [];
        let textNotes = [];
        let selectedObject = null;
        let isDragging = false;
        let dragOffset = { x: 0, y: 0 };

        // Глобальные переменные для музыкального canvas
        let musicCanvas, musicCtx;
        let musicTracks = [];
        let nowplaying = '';
        let audioPlayer = new Audio();
        let currentPlayingTrack = null;

        // Переменные для соединения треков
        let selectedTracks = [];
        let trackConnections = [];

        // Переменная для отслеживания состояния глаза
        let isEyeOpen = false;

        // Инициализация основного canvas
        function initCanvas() {
            canvas = document.getElementById('drawingCanvas');
            ctx = canvas.getContext('2d');
            
            // Устанавливаем размеры canvas
            resizeCanvas();
            
            // Настройки рисования
            ctx.strokeStyle = '#000000';
            ctx.lineWidth = 0.3;

            
            // Обработчики событий
            canvas.addEventListener('mousedown', handleMouseDown);
            canvas.addEventListener('mousemove', handleMouseMove);
            canvas.addEventListener('mouseup', handleMouseUp);
            canvas.addEventListener('dblclick', handleDoubleClick);
            
            // Обработчик изменения размера окна
            window.addEventListener('resize', resizeCanvas);
        }

        // Инициализация музыкального canvas
        function initMusicCanvas() {
            musicCanvas = document.getElementById('musicCanvas');
            musicCtx = musicCanvas.getContext('2d');
            
            // Устанавливаем размеры canvas
            resizeMusicCanvas();
            
            // Загружаем музыкальные треки
            loadMusicTracks();
            
            // Обработчик изменения размера окна
            window.addEventListener('resize', resizeMusicCanvas);
        }

        // Изменение размера основного canvas
        function resizeCanvas() {
            const container = canvas.parentElement;
            canvas.width = container.offsetWidth;
            canvas.height = container.offsetHeight;
            redrawAll();
        }

        // Изменение размера музыкального canvas
        function resizeMusicCanvas() {
            const container = musicCanvas.parentElement;
            musicCanvas.width = container.offsetWidth;
            musicCanvas.height = container.offsetHeight;
            drawTrackConnections();
        }

        // Загрузка музыкальных треков
  // Загрузка музыкальных треков
        function loadMusicTracks() {
            // Данные треков из второго сайта
            musicTracks = [
                { id: 'item1', name: 'Morning Bells ', color: '#000000', x: 2400, y: 400, size: 80, previewUrl: 'assets/3/Modern Biology - Morning Bells.mp3' }, 
                { id: 'item2', name: 'Papaya', color: '#000000', x: 2600, y: 300, size: 77, previewUrl: 'assets/3/Modern Biology - Papaya.mp3' }, 
                { id: 'item3', name: 'Tiger Lily', color: '#000000', x: 1400, y: 800, size: 77, previewUrl: 'assets/3/Modern Biology - Tiger Lily.mp3' }, 
                { id: 'item4', name: 'Mushroom Dance ', color: '#000000', x: 400, y: 1600, size: 75, previewUrl: 'assets/3/modern biology mushroom dance.mp3' }, 
                { id: 'item5', name: 'Mushrooms (Vancouver)', color: '#000000', x: 600, y: 1300, size: 72, previewUrl: 'assets/3/musrooms vancouver modern biology.mp3' }, 
                { id: 'item6', name: 'A Conversation in the Mountains', color: '#000000', x: 1000, y: 1200, size: 82, previewUrl: 'assets/3/Modern Biology - A Conversation in the Mountains.mp3' }, 
                { id: 'item8', name: 'amanita, daughter', color: '#000000', x: 100, y: 1700, size: 78, previewUrl: 'assets/3/01_modern_biology_amanita,_daughter_Amanita:_Mushroom_Music.mp3' }, 
                { id: 'item9', name: 'Campbell River', color: '#000000', x: 1500, y: 1300, size: 76, previewUrl: 'assets/3/01_modern_biology_Dahlia_Campbell_River_Mushroom_Church_Vol_01.mp3' }, 
                 
                { id: 'item11', name: 'swordfern in the morning', color: '#000000', x: 1200, y: 900, size: 75, previewUrl: 'assets/3/02_modern_biology_swordfern_in_the_morning_raag_bhairavi_Plant_Music.mp3' }, 
                { id: 'item13', name: 'To Be A Mushroom', color: '#000000', x: 700, y: 1450, size: 74, previewUrl: 'assets/3/02_modern_biology_To_Be_A_Mushroom_Vancouver_feat_Mendel_Skulski.mp3' }, 
                { id: 'item14', name: 'a conifer tuft', color: '#000000', x: 350, y: 1450, size: 70, previewUrl: 'assets/3/03_modern_biology_a_conifer_tuft_Amanita:_Mushroom_Music.mp3' }, 
                { id: 'item15', name: 'apple tree in the afternoon ', color: '#000000', x: 1800, y: 850, size: 76, previewUrl: 'assets/3/03_modern_biology_apple_tree_in_the_afternoon_raag_bhimpalasi_Plant.mp3' }, 
                { id: 'item16', name: 'japanese maple in the afternoon', color: '#000000', x: 1300, y: 750, size: 78, previewUrl: 'assets/3/04_modern_biology_japanese_maple_in_the_afternoon_raag_bhoopali.mp3' }, 
                { id: 'item17', name: 'fairy creek alder in the evenin', color: '#000000', x: 1700, y: 950, size: 74, previewUrl: 'assets/3/05_modern_biology_fairy_creek_alder_in_the_evening_raag_kafi_Plant.mp3' }, 
                { id: 'item18', name: 'Iris Meditation + Jam ', color: '#000000', x: 1800, y: 1250, size: 79, previewUrl: 'assets/3/01_modern_biology_Iris_Meditation_+_Jam_Amsterdam_Field_Trip_May.mp3' }, 
                { id: 'item19', name: 'Mushrooms (Los Angeles)', color: '#000000', x: 650, y: 1600, size: 71, previewUrl: 'assets/3/05_modern_biology_Mushrooms_Los_Angeles_Mushroom_Church_Vol_01.mp3' }, 
                { id: 'item20', name: 'hemlock at night', color: '#000000', x: 1500, y: 650, size: 72, previewUrl: 'assets/3/06_modern_biology_hemlock_at_night_raag_durga_Plant_Music_Vol_1.mp3' }, 
                { id: 'item21', name: 'Shining Bird of Paradise', color: '#000000', x: 2200, y: 500, size: 79, previewUrl: 'assets/3/01_modern_biology_Shining_Bird_of_Paradise_Plant_Music_Vol_2:_Fruits.mp3' }, 
                { id: 'item22', name: 'Rambutan', color: '#000000', x: 2500, y: 350, size: 75, previewUrl: 'assets/3/02_modern_biology_Rambutan_Plant_Music_Vol_2:_Fruits_and_Flowers.mp3' }, 
                { id: 'item23', name: 'Ginger Flower', color: '#000000', x: 2300, y: 450, size: 76, previewUrl: 'assets/3/03_modern_biology_Ginger_Flower_Plant_Music_Vol_2:_Fruits_and_Flowers.mp3' }, 
                { id: 'item24', name: 'Mangosteen', color: '#000000', x: 2700, y: 400, size: 74, previewUrl: 'assets/3/04_modern_biology_Mangosteen_Plant_Music_Vol_2:_Fruits_and_Flowers.mp3' }, 
                { id: 'item25', name: 'Pineapple', color: '#000000', x: 2400, y: 300, size: 78, previewUrl: 'assets/3/05_modern_biology_Pineapple_Plant_Music_Vol_2:_Fruits_and_Flowers.mp3' }, 
                { id: 'item26', name: 'Passionfruit', color: '#000000', x: 2600, y: 500, size: 73, previewUrl: 'assets/3/_Passionfruit_Plant_Music_Vol_2:_Fruits_and_Flowers_of_Hawaii.mp3' }, 
                { id: 'item27', name: 'Corn (Los Angeles)', color: '#000000', x: 1200, y: 1350, size: 74, previewUrl: 'assets/3/07_modern_biology_Corn_Los_Angeles_Mushroom_Church_Vol_01.mp3' }, 
                { id: 'item28', name: 'Mottled Spurge', color: '#000000', x: 2200, y: 350, size: 71, previewUrl: 'assets/3/07_modern_biology_Mottled_Spurge_Plant_Music_Vol_2:_Fruits_and_Flowers.mp3' }, 
                { id: 'item29', name: 'Hibiscus', color: '#000000', x: 2500, y: 450, size: 75, previewUrl: 'assets/3/08_modern_biology_Hibiscus_Plant_Music_Vol_2:_Fruits_and_Flowers.mp3' }, 
                { id: 'item30', name: 'Japanese Maple (Toronto)', color: '#000000', x: 1400, y: 1000, size: 73, previewUrl: 'assets/3/08_modern_biology_Japanese_Maple_Toronto_Mushroom_Church_Vol_01.mp3' }, 
                { id: 'item31', name: 'Pink Oyster (Vancouver)', color: '#000000', x: 150, y: 1350, size: 73, previewUrl: 'assets/3/10_modern_biology_Pink_Oyster_Vancouver_Mushroom_Church_Vol_01.mp3' }, 
          //     { id: 'item11', name: 'The Waves, Escape, and Relax with This Feeling', color: '#000000', x: 700, y: 535, size: 130, previewUrl: 'https://p.scdn.co/mp3-preview/1ef353a676e073f51e9606eef4447e472e8ca005', spotifyId: '6T6Idnzi7S5J8YM8uA2wiK' }, // title="e.g. Sleeping Waves Falls Lullaby "The Waves, Escape, and Relax with This Feeling"
            //     { id: 'item12', name: 'Empty Beach', color: '#000000', x: 1394, y: 900, size: 130, previewUrl: 'https://p.scdn.co/mp3-preview/8c8d5e3589bc075858196799e24280c61ecbe0c4', spotifyId: '3CwAf6F0wwS7sMSk4sDb69' }, // Serenity of Sound "Empty Beach""
            ];
           
            drawMusicTracks();
        }

        // Отрисовка музыкальных треков
        function drawMusicTracks() {
            // Очищаем canvas
            musicCtx.clearRect(0, 0, musicCanvas.width, musicCanvas.height);
            
            // Создаем DOM элементы для каждого трека
            const container = musicCanvas.parentElement;
            
            // Удаляем старые элементы
            const oldTracks = container.querySelectorAll('.music-track');
            oldTracks.forEach(track => track.remove());
            
            // Создаем новые элементы
            musicTracks.forEach(track => {
                const trackElement = document.createElement('div');
                trackElement.className = 'music-track';
                trackElement.id = track.id;
                trackElement.textContent = track.name;
                trackElement.style.color = track.color;
                trackElement.style.left = (track.x / 3000 * 100) + '%';
                trackElement.style.top = (track.y / 2000 * 100) + '%';


                // После этой строки:
                trackElement.style.fontSize = (track.size / 100) + 'rem';

                // ДОБАВЬТЕ ЭТУ СТРОКУ:
                trackElement.setAttribute('data-preview-url', track.previewUrl);
                                
                // Обработчик клика
                trackElement.addEventListener('click', () => handleTrackClick(track, trackElement));
                
                container.appendChild(trackElement);
            });
            
            // Отрисовываем соединения между треками
            drawTrackConnections();
        }

        // ЗАМЕНИТЕ старую функцию handleTrackClick на эту:
        function handleTrackClick(track, trackElement) {
            loadAndPlayTrack(track, trackElement);
            
            // Если это не первый выбранный трек, создаем связь с предыдущим
            if (selectedTracks.length > 0) {
                const previousTrack = selectedTracks[selectedTracks.length - 1];
                createTrackConnection(previousTrack, track);
            }
            
            // Добавляем трек в список выбранных
            selectedTracks.push(track);
            
            // Визуально выделяем выбранный трек
            trackElement.classList.add('selected');
        }

                // ДОБАВЬТЕ ЭТУ ФУНКЦИЮ ПОСЛЕ функции handleTrackClick:
        function loadAndPlayTrack(track, trackElement) {
            if (nowplaying === track.name) {
                // Если трек уже играет, останавливаем его
                audioPlayer.pause();
                nowplaying = '';
                if (currentPlayingTrack) {
                    currentPlayingTrack.classList.remove('playing');
                }
            } else {
                // Останавливаем текущий трек
                audioPlayer.pause();
                if (currentPlayingTrack) {
                    currentPlayingTrack.classList.remove('playing');
                }
                
                // Загружаем и воспроизводим новый трек только при клике
                audioPlayer.src = track.previewUrl;
                audioPlayer.preload = 'none'; // Не загружать заранее
                audioPlayer.load(); // Принудительно загружаем только сейчас
                audioPlayer.play().catch(error => {
                    console.log('Автовоспроизведение заблокировано:', error);
                });
                nowplaying = track.name;
                
                // Подсвечиваем текущий трек
                trackElement.classList.add('playing');
                currentPlayingTrack = trackElement;
                
                // Автоматически снимаем выделение после окончания трека
                audioPlayer.onended = function() {
                    nowplaying = '';
                    if (currentPlayingTrack) {
                        currentPlayingTrack.classList.remove('playing');
                    }
                };
            }
        }
                
        // Создание соединения между треками
        function createTrackConnection(track1, track2) {
            // Проверяем, нет ли уже такого соединения
            const existingConnection = trackConnections.find(conn => 
                (conn.track1 === track1 && conn.track2 === track2) || 
                (conn.track1 === track2 && conn.track2 === track1)
            );
            
            if (!existingConnection) {
                // Добавляем новое соединение
                trackConnections.push({
                    track1: track1,
                    track2: track2,
                    color: '#000000',
                    width: 1
                });
                
                // Перерисовываем соединения
                drawTrackConnections();
            }
        }

        function drawTrackConnections() {
            // Очищаем canvas
            musicCtx.clearRect(0, 0, musicCanvas.width, musicCanvas.height);
            
            // Отрисовываем все соединения
            trackConnections.forEach(connection => {
                const track1 = connection.track1;
                const track2 = connection.track2;
                
                // Получаем координаты центров треков
                const x1 = (track1.x / 3000) * musicCanvas.width;
                const y1 = (track1.y / 2000) * musicCanvas.height;
                const x2 = (track2.x / 3000) * musicCanvas.width;
                const y2 = (track2.y / 2000) * musicCanvas.height;
                
                // Вычисляем вектор направления
                const dx = x2 - x1;
                const dy = y2 - y1;
                const length = Math.sqrt(dx * dx + dy * dy);
                
                // Нормализуем вектор
                const unitX = dx / length;
                const unitY = dy / length;
                
                // Укорачиваем линию на 20px с каждой стороны
                const shortenBy = 20;
                const startX = x1 + unitX * shortenBy;
                const startY = y1 + unitY * shortenBy;
                const endX = x2 - unitX * shortenBy;
                const endY = y2 - unitY * shortenBy;
                
                // Рисуем укороченную линию
                musicCtx.beginPath();
                musicCtx.moveTo(startX, startY);
                musicCtx.lineTo(endX, endY);
                musicCtx.strokeStyle = connection.color;
                musicCtx.lineWidth = connection.width;
                musicCtx.stroke();
            });
        }

        // Воспроизведение трека
        function playTrack(track) {
            if (nowplaying === track.name) {
                // Если трек уже играет, останавливаем его
                audioPlayer.pause();
                nowplaying = '';
                if (currentPlayingTrack) {
                    currentPlayingTrack.classList.remove('playing');
                }
            } else {
                // Останавливаем текущий трек
                audioPlayer.pause();
                if (currentPlayingTrack) {
                    currentPlayingTrack.classList.remove('playing');
                }
                
                // Воспроизводим новый трек
                audioPlayer.src = track.previewUrl;
                audioPlayer.play();
                nowplaying = track.name;
                
                // Подсвечиваем текущий трек
                const trackElement = document.getElementById(track.id);
                if (trackElement) {
                    trackElement.classList.add('playing');
                    currentPlayingTrack = trackElement;
                }
                
                // Автоматически снимаем выделение после окончания трека
                audioPlayer.onended = function() {
                    nowplaying = '';
                    if (currentPlayingTrack) {
                        currentPlayingTrack.classList.remove('playing');
                    }
                };
            }
        }

        // Функция очистки всех связей
        function clearAllConnections() {
            trackConnections = [];
            selectedTracks = [];
            musicCtx.clearRect(0, 0, musicCanvas.width, musicCanvas.height);
            
            // Снимаем выделение со всех треков
            document.querySelectorAll('.music-track.selected').forEach(track => {
                track.classList.remove('selected');
            });
            
        }

        // Установка инструмента
        function setTool(tool) {
            currentTool = tool;
        }

        // Получение координат мыши относительно canvas
        function getMousePos(e) {
            const rect = canvas.getBoundingClientRect();
            return {
                x: e.clientX - rect.left,
                y: e.clientY - rect.top
            };
        }

        // Обработчик нажатия мыши
        function handleMouseDown(e) {
            // Реализация при необходимости
        }

        // Обработчик движения мыши
        function handleMouseMove(e) {
            // Реализация при необходимости
        }

        // Обработчик отпускания мыши
        function handleMouseUp(e) {
            // Реализация при необходимости
        }

        // Обработчик двойного клика для текстовых заметок
        function handleDoubleClick(e) {
            // Реализация при необходимости
        }

        // Поиск объекта в указанных координатах
        function findObjectAt(x, y) {
            for (let i = drawnObjects.length - 1; i >= 0; i--) {
                const obj = drawnObjects[i];
                if (obj.type !== 'freehand' && 
                    x >= obj.x && x <= obj.x + obj.width &&
                    y >= obj.y && y <= obj.y + obj.height) {
                    return obj;
                }
            }
            return null;
        }

        // Перерисовка всех объектов
        function redrawAll() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // Восстанавливаем настройки
            ctx.strokeStyle = '#000000';
            ctx.lineWidth = 1;
            ctx.lineCap = 'round';
            ctx.lineJoin = 'round';
            ctx.setLineDash([]);
            
            // Рисуем все сохраненные объекты
            drawnObjects.forEach(obj => {
                switch(obj.type) {
                    case 'freehand':
                        ctx.putImageData(obj.imageData, 0, 0);
                        break;
                }
            });
        }

        // Очистка холста
        function clearCanvas() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            drawnObjects = [];
            
            // Удаляем все текстовые заметки
            textNotes.forEach(note => {
                if (note.element && note.element.parentNode) {
                    note.element.parentNode.removeChild(note.element);
                }
            });
            textNotes = [];
        }

        // Переключение изображения с анимацией глаза
        function toggleImage() {
            const image = document.getElementById('hiddenImage');
            const eyeButton = document.getElementById('imageToggle');
            
            if (image.style.display === 'none') {
                image.style.display = 'block';
                eyeButton.textContent = '⚆'; // Открытый глаз
                isEyeOpen = true;
            } else {
                image.style.display = 'none';
                eyeButton.textContent = '◠'; // Закрытый глаз
                isEyeOpen = false;
            }
        }

        // Навигация
        function navigateToPage(page) {
            window.location.href = page;
        }

        // Функция для переключения описаний
        function toggleDescriptions() {
            const toggle = document.getElementById('descriptionsToggle');
            const content = document.getElementById('descriptionsContent');
            
            toggle.classList.toggle('active');
            content.classList.toggle('active');
        }

        // Закрытие описаний при клике вне области
        document.addEventListener('click', function(event) {
            const toggle = document.getElementById('descriptionsToggle');
            const content = document.getElementById('descriptionsContent');
            
            if (!toggle.contains(event.target) && !content.contains(event.target)) {
                toggle.classList.remove('active');
                content.classList.remove('active');
            }
        });

         // НА ЭТУ:
        window.addEventListener('load', function() {
            initCanvas();
            initMusicCanvas();
            
            // Добавляем обработчик для кнопки описаний
            document.getElementById('descriptionsToggle').addEventListener('click', toggleDescriptions);
            
            // ДОБАВЛЕНО: Предзагрузка только первых 2 треков для ускорения начальной загрузки
            preloadFirstTracks(2);
        });

        // ДОБАВЬТЕ ЭТУ ФУНКЦИЮ В КОНЕЦ СКРИПТА 
        function preloadFirstTracks(count) {
            for (let i = 0; i < Math.min(count, musicTracks.length); i++) {
                const track = musicTracks[i];
                // Предзагружаем только Spotify треки (они маленькие)
                if (track.previewUrl.includes('p.scdn.co')) {
                    const preloadAudio = new Audio();
                    preloadAudio.src = track.previewUrl;
                    preloadAudio.preload = 'metadata'; // Только метаданные, не весь файл
                }
            }
        }
    </script>
    
</body>
</html>

      