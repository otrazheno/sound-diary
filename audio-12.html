<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>12</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Literata:ital,opsz,wght@0,7..72,200..900;1,7..72,200..900&family=Crimson+Text:ital,wght@0,400;0,600;1,400;1..600&display=swap" rel="stylesheet">
    
    <link rel="icon" href="favicon.ico">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon16.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon32.png">
    <link rel="apple-touch-icon" sizes="180x180" href="assets/favicons/apple.png">
    
    
    
    
    
    <style>
        /* === БАЗОВЫЕ СТИЛИ === */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Literata', serif;
            background-color: #ffffff;
            color: #000000;
            line-height: 1.5;
            width: 100%;
            min-height: 100vh;
            overflow-x: auto;
        }

        .container {
            position: relative;
            margin: 0 auto;
            background-color: #ffffff;
            min-height: 100vh;
            padding: 1rem;
            max-width: 100%;
        }

        /* === ВЕРХНЯЯ НАВИГАЦИЯ === */
        .header-navigation {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
            margin-bottom: 1rem;
            padding: 0 1rem;
            position: fixed;
            top: 1rem;
            left: 0;
            gap: 1rem;
            z-index: 10;
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
        }

        .nav-back {
            font-family: 'Literata', serif;
            font-size: 1rem;
            line-height: 2.25rem;
            font-weight: 400;
            color: #000000;
            cursor: pointer;
            transition: opacity 0.3s ease;
            flex: 0 0 auto;
        }

        .nav-back:hover {
            opacity: 0.7;
        }

        .nav-about {
            font-family: 'Literata', serif;
            font-size: 0.8rem;
            line-height: 2.25rem;
            font-weight: 400;
            color: #000000;
            cursor: pointer;
            transition: opacity 0.3s ease;
            flex: 0 0 auto;
        }

        .nav-about:hover {
            opacity: 0.7;
        }

        /* === ИЗОБРАЖЕНИЕ ПОЭЗИИ === */
        .poetry-image {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 5;
            pointer-events: none;
            max-width: 15%;
            max-height: 25%;
            opacity: 0.9;
            filter: contrast(1.1) brightness(1.05);
        }

        .poetry-image img {
            width: 100%;
            height: auto;
            display: block;
        }

        /* === ОСНОВНАЯ ОБЛАСТЬ С ГРАФИКОЙ === */
        .main-content {
            position: relative;
            width: 100%;
            min-height: 500px;
            display: flex;
            justify-content: center;
            align-items: center;
            margin-top: 80px;
        }

        .canvas-container {
            position: relative;
            width: 100%;
            max-width: none;
            height: 100vh;
            aspect-ratio: none;
        }

        .graphic-canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-repeat: no-repeat;
            background-position: center;
            background-size: contain;
            transition: all 0.5s ease-in-out;
            z-index: 1;
        }

        #drawingCanvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            cursor: crosshair;
            z-index: 2;
        }

        /* === ВСПЛЫВАЮЩАЯ КНОПКА ОПИСАНИЙ === */
        .descriptions-popup {
            position: fixed;
            bottom: 6rem;
            right: 2rem;
            z-index: 20;
            transition: all 0.3s ease;
        }

        .descriptions-toggle {
            background-color: #ffffff;
            border: 1.5px solid #000000;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            font-family: 'Literata', serif;
            font-size: 1.2rem;
            font-weight: 400;
            color: #000000;
            transition: all 0.3s ease;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .descriptions-toggle:hover {
            background-color: #f0f0f0;
            transform: scale(1.05);
        }

        .descriptions-toggle.active {
            background-color: #000000;
            color: #ffffff;
        }

        .descriptions-content {
            position: absolute;
            bottom: 60px;
            right: 0;
            width: min(90vw, 500px);
            max-height: min(60vh, 450px);
            background-color: #ffffff;
            border: 1.5px solid #000000;
            padding: 1.5rem;
            overflow-y: auto;
            display: none;
        }

        .descriptions-content.active {
            display: block;
        }

        .description-item {
            display: flex;
            gap: 1rem;
            align-items: flex-start;
            margin-bottom: 1.5rem;
        }

        .description-number {
            font-family: 'Literata', serif;
            font-size: 1rem;
            font-weight: 400;
            min-width: 1.5rem;
            flex-shrink: 0;
        }

        .description-content {
            flex: 1;
        }

        .description-title {
            font-family: 'Crimson Text', serif;
            font-style: italic;
            font-size: 1rem;
            font-weight: 400;
            margin-bottom: 0.25rem;
            line-height: 1.3;
            text-align: justify;
        }

        /* === ПАНЕЛЬ УПРАВЛЕНИЯ === */
        .control-panel {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 1rem;
            z-index: 10;
        }

        .coordinate-text {
            font-family: 'Literata', serif;
            font-size: 0.8rem;
            text-align: right;
            color: #000000;
            line-height: 1.3;
        }

        /* === МУЗЫКАЛЬНЫЙ CANVAS === */
        .music-canvas-container {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 4;
            pointer-events: none;
        }

        #musicCanvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: auto;
        }

        .music-track {
            position: absolute;
            padding: 0px 2px;
            white-space: nowrap;
            cursor: pointer;
            font-family: 'Literata', serif;
            pointer-events: auto;
            transition: all 0.3s ease;
        }

        .music-track:hover {
            color: black !important;
            transform: scale(1.05);
        }

        .music-track.playing {
            font-weight: bold;
            padding: 1px 2px;
            background: rgb(255, 255, 255);
            border-color: black;
            border-style: solid;
            border-width: 1px 1px 1px 8px;
            z-index: 1000;
        }

        .music-track.playing:before {
            content: "\266B";
            color: black;
            margin-right: 4px;
        }

        /* === АДАПТИВНЫЕ СТИЛИ === */
        @media screen and (max-width: 767px) {
            .header-navigation {
                padding: 0 0.5rem;
                gap: 0.5rem;
            }
            
            .nav-back {
                font-size: 0.9rem;
            }
            
            .nav-about {
                font-size: 0.7rem;
            }
            
            .main-content {
                margin-top: 60px;
            }
            
            .poetry-image {
                max-width: 80%;
                max-height: 60%;
            }
            
            .descriptions-popup {
                bottom: 5rem;
                right: 1rem;
            }
            
            .descriptions-content {
                width: 350px;
                max-height: 350px;
                padding: 1rem;
            }
            
            .control-panel {
                bottom: 1rem;
                right: 1rem;
            }
        }

        @media screen and (max-width: 600px) {
            .poetry-image {
                max-width: 85%;
                max-height: 50%;
            }
            
            .descriptions-content {
                width: 300px;
                max-height: 300px;
            }
        }

        @media screen and (max-width: 479px) {
            .poetry-image {
                max-width: 90%;
                max-height: 45%;
            }
        }
    </style>
</head>
<body>
    <div class="container" id="canvasContainer">
        <!-- Верхняя навигация -->
        <header class="header-navigation">
            <div class="nav-back" onclick="navigateToPage('map.html')">←</div>
            <div class="nav-about" onclick="navigateToPage('info.html')">О ПРОЕКТЕ</div>
        </header>

        <!-- Изображение поэзии -->
        <div class="poetry-image">
            <img src="assets/audio-12.jpg" alt="благодарность" onerror="this.style.display='none'">
        </div>

        <!-- Основная область с графическим элементом -->
        <main class="main-content">
            <div class="canvas-container">
                <div class="graphic-canvas" id="hiddenImage" style="display:none"></div>
                <canvas id="drawingCanvas"></canvas>
                
                <!-- Музыкальный canvas -->
                <div class="music-canvas-container">
                    <canvas id="musicCanvas"></canvas>
                </div>
            </div>
        </main>

        <!-- Всплывающая кнопка описаний -->
        <div class="descriptions-popup">
            <div class="descriptions-toggle" id="descriptionsToggle" title="Описания работ">
                i
            </div>
            <div class="descriptions-content" id="descriptionsContent">
                <div class="description-item">
                    <div class="description-number"></div>
                    <div class="description-content">
                        <div class="description-title">
                            Dialogues about personal experiences and everyday life. <br> <br>Some notes from personal collection.  Conversations with strangers. These  collected — moments of vulnerability and connection, where the ephemeral exchange on a park bench or a train platform becomes a permanent, resonant truth about our shared existence.
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Панель управления -->
        <div class="control-panel">
            <div class="coordinate-text">SCALE YOUR SCREEN<br> FIND THE RIGHT DISTANCE<br> CTRL + S FOR SAVE</div>
        </div>
    </div>

    <script>
        // Глобальные переменные для основного canvas
        let canvas, ctx;
        let currentTool = 'draw';
        let isDrawing = false;
        let startX, startY;
        let drawnObjects = [];
        let textNotes = [];
        let selectedObject = null;
        let isDragging = false;
        let dragOffset = { x: 0, y: 0 };

        // Глобальные переменные для музыкального canvas
        let musicCanvas, musicCtx;
        let musicTracks = [];
        let nowplaying = '';
        let audioPlayer = new Audio();
        let currentPlayingTrack = null;

        // Переменные для соединения треков
        let selectedTracks = [];
        let trackConnections = [];

        // Инициализация основного canvas
        function initCanvas() {
            canvas = document.getElementById('drawingCanvas');
            ctx = canvas.getContext('2d');
            
            // Устанавливаем размеры canvas
            resizeCanvas();
            
            // Настройки рисования
            ctx.strokeStyle = '#000000';
            ctx.lineWidth = 0.3;

            
            // Обработчики событий
            canvas.addEventListener('mousedown', handleMouseDown);
            canvas.addEventListener('mousemove', handleMouseMove);
            canvas.addEventListener('mouseup', handleMouseUp);
            canvas.addEventListener('dblclick', handleDoubleClick);
            
            // Обработчик изменения размера окна
            window.addEventListener('resize', resizeCanvas);
        }

        // Инициализация музыкального canvas
        function initMusicCanvas() {
            musicCanvas = document.getElementById('musicCanvas');
            musicCtx = musicCanvas.getContext('2d');
            
            // Устанавливаем размеры canvas
            resizeMusicCanvas();
            
            // Загружаем музыкальные треки
            loadMusicTracks();
            
            // Обработчик изменения размера окна
            window.addEventListener('resize', resizeMusicCanvas);
        }

        // Изменение размера основного canvas
        function resizeCanvas() {
            const container = canvas.parentElement;
            canvas.width = container.offsetWidth;
            canvas.height = container.offsetHeight;
            redrawAll();
        }

        // Изменение размера музыкального canvas
        function resizeMusicCanvas() {
            const container = musicCanvas.parentElement;
            musicCanvas.width = container.offsetWidth;
            musicCanvas.height = container.offsetHeight;
            drawTrackConnections();
        }

        // Загрузка музыкальных треков с новыми координатами ближе к углам
        function loadMusicTracks() {
            musicTracks = [
                // Верхний левый угол
                { id: 'item1', name: '⌒', color: '#000000', x: 100, y: 100, size: 90, previewUrl: 'assets/12/Без названия.mp3' }, 
                { id: 'item2', name: 'Interview with a cat', color: '#000000', x: 100, y: 1800, size: 95, previewUrl: 'assets/12/534297111.mp3' }, 
                
                // Верхний правый угол
                { id: 'item3', name: 'Partly Fiction', color: '#000000', x: 300, y: 100, size: 80, previewUrl: 'assets/12/Partly Fiction.mp3' }, 
                { id: 'item4', name: 'by Wim Wenders', color: '#000000', x: 250, y: 200, size: 80, previewUrl: 'assets/12/Notebook on city and clothes.mp3' }, 
               
                // Нижний левый угол
                { id: 'item5', name: 'Hedgehog In The Fog', color: '#000000',x: 1500, y: 200, size: 110, previewUrl: 'assets/12/IMG_0797.mp3' }, 
                 { id: 'item6', name: 'Norstein', color: '#000000', x: 150, y: 1700, size: 80, previewUrl: 'assets/12/Norshtein.mp3' }, 
                
                // Нижний правый угол
                // { id: 'item7', name: 'Jul, 27', color: '#000000', x: 2600, y: 500, size: 85, previewUrl: 'assets/12/files (online-audio-converter.com)/2025-07-27 23.38.48.mp3' }, 
                { id: 'item8', name: 'Feb, 25', color: '#000000', x: 2750, y: 700, size: 95, previewUrl: 'assets/12/2025-11-23 02.13.21.mp3' }, 
                
                // Центральные позиции (ближе к краям)
                { id: 'item9', name: 'Nov, 2024', color: '#000000', x: 2800, y: 500, size: 80, previewUrl: 'assets/12/2024-11-15 17.14.49 .mp3' }, 
                { id: 'item10', name: 'Jul, 25', color: '#000000', x: 2800, y: 300, size: 80, previewUrl: 'assets/12/2025-07-27 23.38.48.mp3' }, 
                { id: 'item11', name: 'Jul, 24', color: '#000000', x: 2700, y: 150, size: 80, previewUrl: 'assets/12/30 07.mp3' }, 
                { id: 'item12', name: 'Greetings in 55 Languages', color: '#000000', x: 1500, y: 1850, size: 85, previewUrl: 'assets/12/Nasa Voyager Golden Record - Greetings in 55 Languages.mp3' }, 
            ];
            drawMusicTracks();
        }

        // Отрисовка музыкальных треков
        function drawMusicTracks() {
            // Очищаем canvas
            musicCtx.clearRect(0, 0, musicCanvas.width, musicCanvas.height);
            
            // Создаем DOM элементы для каждого трека
            const container = musicCanvas.parentElement;
            
            // Удаляем старые элементы
            const oldTracks = container.querySelectorAll('.music-track');
            oldTracks.forEach(track => track.remove());
            
            // Создаем новые элементы
            musicTracks.forEach(track => {
                const trackElement = document.createElement('div');
                trackElement.className = 'music-track';
                trackElement.id = track.id;
                trackElement.textContent = track.name;
                trackElement.style.color = track.color;
                trackElement.style.left = (track.x / 3000 * 100) + '%';
                trackElement.style.top = (track.y / 2000 * 100) + '%';
                trackElement.style.fontSize = (track.size / 100) + 'rem';

                trackElement.setAttribute('data-preview-url', track.previewUrl);
                
                // Обработчик клика
                trackElement.addEventListener('click', () => handleTrackClick(track, trackElement));
                
                container.appendChild(trackElement);
            });
            
            // Отрисовываем соединения между треками
            drawTrackConnections();
        }

        // ЗАМЕНИТЕ старую функцию handleTrackClick на эту:
        function handleTrackClick(track, trackElement) {
            loadAndPlayTrack(track, trackElement);
            
            // Если это не первый выбранный трек, создаем связь с предыдущим
            if (selectedTracks.length > 0) {
                const previousTrack = selectedTracks[selectedTracks.length - 1];
                createTrackConnection(previousTrack, track);
            }
            
            // Добавляем трек в список выбранных
            selectedTracks.push(track);
            
            // Визуально выделяем выбранный трек
            trackElement.classList.add('selected');
        }

                // ДОБАВЬТЕ ЭТУ ФУНКЦИЮ ПОСЛЕ функции handleTrackClick:
        function loadAndPlayTrack(track, trackElement) {
            if (nowplaying === track.name) {
                // Если трек уже играет, останавливаем его
                audioPlayer.pause();
                nowplaying = '';
                if (currentPlayingTrack) {
                    currentPlayingTrack.classList.remove('playing');
                }
            } else {
                // Останавливаем текущий трек
                audioPlayer.pause();
                if (currentPlayingTrack) {
                    currentPlayingTrack.classList.remove('playing');
                }
                
                // Загружаем и воспроизводим новый трек только при клике
                audioPlayer.src = track.previewUrl;
                audioPlayer.preload = 'none'; // Не загружать заранее
                audioPlayer.load(); // Принудительно загружаем только сейчас
                audioPlayer.play().catch(error => {
                    console.log('Автовоспроизведение заблокировано:', error);
                });
                nowplaying = track.name;
                
                // Подсвечиваем текущий трек
                trackElement.classList.add('playing');
                currentPlayingTrack = trackElement;
                
                // Автоматически снимаем выделение после окончания трека
                audioPlayer.onended = function() {
                    nowplaying = '';
                    if (currentPlayingTrack) {
                        currentPlayingTrack.classList.remove('playing');
                    }
                };
            }
        }
        
        // Создание соединения между треками
        function createTrackConnection(track1, track2) {
            // Проверяем, нет ли уже такого соединения
            const existingConnection = trackConnections.find(conn => 
                (conn.track1 === track1 && conn.track2 === track2) || 
                (conn.track1 === track2 && conn.track2 === track1)
            );
            
            if (!existingConnection) {
                // Добавляем новое соединение
                trackConnections.push({
                    track1: track1,
                    track2: track2,
                    color: '#000000',
                    width: 1
                });
                
                // Перерисовываем соединения
                drawTrackConnections();
            }
        }

        function drawTrackConnections() {
            // Очищаем canvas
            musicCtx.clearRect(0, 0, musicCanvas.width, musicCanvas.height);
            
            // Отрисовываем все соединения
            trackConnections.forEach(connection => {
                const track1 = connection.track1;
                const track2 = connection.track2;
                
                // Получаем координаты центров треков
                const x1 = (track1.x / 3000) * musicCanvas.width;
                const y1 = (track1.y / 2000) * musicCanvas.height;
                const x2 = (track2.x / 3000) * musicCanvas.width;
                const y2 = (track2.y / 2000) * musicCanvas.height;
                
                // Вычисляем вектор направления
                const dx = x2 - x1;
                const dy = y2 - y1;
                const length = Math.sqrt(dx * dx + dy * dy);
                
                // Нормализуем вектор
                const unitX = dx / length;
                const unitY = dy / length;
                
                // Укорачиваем линию на 20px с каждой стороны
                const shortenBy = 20;
                const startX = x1 + unitX * shortenBy;
                const startY = y1 + unitY * shortenBy;
                const endX = x2 - unitX * shortenBy;
                const endY = y2 - unitY * shortenBy;
                
                // Рисуем укороченную линию
                musicCtx.beginPath();
                musicCtx.moveTo(startX, startY);
                musicCtx.lineTo(endX, endY);
                musicCtx.strokeStyle = connection.color;
                musicCtx.lineWidth = connection.width;
                musicCtx.stroke();
            });
        }

        // Воспроизведение трека
        function playTrack(track) {
            if (nowplaying === track.name) {
                // Если трек уже играет, останавливаем его
                audioPlayer.pause();
                nowplaying = '';
                if (currentPlayingTrack) {
                    currentPlayingTrack.classList.remove('playing');
                }
            } else {
                // Останавливаем текущий трек
                audioPlayer.pause();
                if (currentPlayingTrack) {
                    currentPlayingTrack.classList.remove('playing');
                }
                
                // Воспроизводим новый трек
                audioPlayer.src = track.previewUrl;
                audioPlayer.play();
                nowplaying = track.name;
                
                // Подсвечиваем текущий трек
                const trackElement = document.getElementById(track.id);
                if (trackElement) {
                    trackElement.classList.add('playing');
                    currentPlayingTrack = trackElement;
                }
                
                // Автоматически снимаем выделение после окончания трека
                audioPlayer.onended = function() {
                    nowplaying = '';
                    if (currentPlayingTrack) {
                        currentPlayingTrack.classList.remove('playing');
                    }
                };
            }
        }

        // Функция очистки всех связей
        function clearAllConnections() {
            trackConnections = [];
            selectedTracks = [];
            musicCtx.clearRect(0, 0, musicCanvas.width, musicCanvas.height);
            
            // Снимаем выделение со всех треков
            document.querySelectorAll('.music-track.selected').forEach(track => {
                track.classList.remove('selected');
            });
        }

        // Перерисовка всех объектов
        function redrawAll() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // Восстанавливаем настройки
            ctx.strokeStyle = '#000000';
            ctx.lineWidth = 1;
            ctx.lineCap = 'round';
            ctx.lineJoin = 'round';
            ctx.setLineDash([]);
            
            // Рисуем все сохраненные объекты
            drawnObjects.forEach(obj => {
                switch(obj.type) {
                    case 'freehand':
                        ctx.putImageData(obj.imageData, 0, 0);
                        break;
                }
            });
        }

        // Навигация
        function navigateToPage(page) {
            window.location.href = page;
        }

        // Функция для переключения описаний
        function toggleDescriptions() {
            const toggle = document.getElementById('descriptionsToggle');
            const content = document.getElementById('descriptionsContent');
            
            toggle.classList.toggle('active');
            content.classList.toggle('active');
        }

        // Закрытие описаний при клике вне области
        document.addEventListener('click', function(event) {
            const toggle = document.getElementById('descriptionsToggle');
            const content = document.getElementById('descriptionsContent');
            
            if (!toggle.contains(event.target) && !content.contains(event.target)) {
                toggle.classList.remove('active');
                content.classList.remove('active');
            }
        });

        // Инициализация при загрузке страницы
        window.addEventListener('load', function() {
            initCanvas();
            initMusicCanvas();
            
            // Добавляем обработчик для кнопки описаний
            document.getElementById('descriptionsToggle').addEventListener('click', toggleDescriptions);
            
            // ДОБАВЛЕНО: Предзагрузка только первых 2 треков для ускорения начальной загрузки
            preloadFirstTracks(2);
        });

        // ДОБАВЬТЕ ЭТУ ФУНКЦИЮ В КОНЕЦ СКРИПТА 
        function preloadFirstTracks(count) {
            for (let i = 0; i < Math.min(count, musicTracks.length); i++) {
                const track = musicTracks[i];
                // Предзагружаем только Spotify треки (они маленькие)
                if (track.previewUrl.includes('p.scdn.co')) {
                    const preloadAudio = new Audio();
                    preloadAudio.src = track.previewUrl;
                    preloadAudio.preload = 'metadata'; // Только метаданные, не весь файл
                }
            }
        }

        // Пустые функции для обработки событий canvas (оставлены для совместимости)
        function handleMouseDown(e) {}
        function handleMouseMove(e) {}
        function handleMouseUp(e) {}
        function handleDoubleClick(e) {}
        function findObjectAt(x, y) { return null; }
        function clearCanvas() {}
        function setTool(tool) {}
        function getMousePos(e) { return { x: 0, y: 0 }; }
    </script>
</body>
</html>