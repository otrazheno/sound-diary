<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>1</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Literata:ital,opsz,wght@0,7..72,200..900;1,7..72,200..900&family=Crimson+Text:ital,wght@0,400;0,600;1,400;1..600&display=swap" rel="stylesheet">
    
    <link rel="icon" href="favicon.ico">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon16.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon32.png">
    <link rel="apple-touch-icon" sizes="180x180" href="assets/favicons/apple.png">
    
    
    <style>
        /* === БАЗОВЫЕ СТИЛИ === */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Literata', serif;
            background-color: #ffffff;
            color: #000000;
            line-height: 1.5;
            width: 100%;
            min-height: 100vh;
            overflow-x: auto;
        }

        .container {
            position: relative;
            margin: 0 auto;
            background-color: #ffffff;
            min-height: 100vh;
            padding: 1rem;
            max-width: 100%;
        }

        /* === ВЕРХНЯЯ НАВИГАЦИЯ === */
        .header-navigation {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
            margin-bottom: 1rem;
            padding: 0 1rem;
            position: fixed;
            top: 1rem;
            left: 0;
            gap: 1rem;
            z-index: 10;
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
        }

        .nav-back {
            font-family: 'Literata', serif;
            font-size: 1rem;
            line-height: 2.25rem;
            font-weight: 400;
            color: #000000;
            cursor: pointer;
            transition: opacity 0.3s ease;
            flex: 0 0 auto;
        }

        .nav-back:hover {
            opacity: 0.7;
        }


        .nav-about {
            font-family: 'Literata', serif;
            font-size: 0.8rem;
            line-height: 2.25rem;
            font-weight: 400;
            color: #000000;
            cursor: pointer;
            transition: opacity 0.3s ease;
            flex: 0 0 auto;
        }

        .nav-about:hover {
            opacity: 0.7;
        }

        /* === ОСНОВНАЯ ОБЛАСТЬ С ГРАФИКОЙ === */
        .main-content {
            position: relative;
            width: 100%;
            min-height: 500px;
            display: flex;
            justify-content: center;
            align-items: center;
            margin-top: 80px;
        }

        .canvas-container {
            position: relative;
            width: 100%;
            max-width: none;
            height: 100vh;
            aspect-ratio: none;
        }

        .graphic-canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: url('/Users/macbookpro/Desktop/sound-diary/assets/images/1.png');
            background-repeat: no-repeat;
            background-position: center;
            background-size: contain;
            transition: all 0.5s ease-in-out;
            z-index: 1;
        }

        #drawingCanvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            cursor: crosshair;
            z-index: 2;
        }



        /* === ВСПЛЫВАЮЩАЯ КНОПКА ОПИСАНИЙ === */
        .descriptions-popup {
            position: fixed;
            bottom: 6rem;
            right: 2rem;
            z-index: 20;
            transition: all 0.3s ease;
        }

        .descriptions-toggle {
            background-color: #ffffff;
            border: 1.5px solid #000000;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            font-family: 'Literata', serif;
            font-size: 1.2rem;
            font-weight: 400;
            color: #000000;
            transition: all 0.3s ease;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .descriptions-toggle:hover {
            background-color: #f0f0f0;
            transform: scale(1.05);
        }

        .descriptions-toggle.active {
            background-color: #000000;
            color: #ffffff;
        }

        .descriptions-content {
            position: absolute;
            bottom: 60px;
            right: 0;
            width: min(90vw, 500px);
            max-height: min(60vh, 450px);
            background-color: #ffffff;
            border: 1.5px solid #000000;
            padding: 1.5rem;
            overflow-y: auto;
            display: none;
        }

        .descriptions-content.active {
            display: block;
        }

        .descriptions {
            grid-template-columns: 1fr;
            gap: 1.5rem;
            margin-right: 10%;
            margin-top: 15%;
        }

        .description-column {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }

        .description-item {
            display: flex;
            gap: 1rem;
            align-items: flex-start;
        }

        .description-number {
            font-family: 'Literata', serif;
            font-size: 1rem;
            font-weight: 400;
            min-width: 1.5rem;
            flex-shrink: 0;
        }

        .description-content {
            flex: 1;
        }

        .description-title {
            font-family: 'Crimson Text', serif;
            font-style: italic;
            font-size: 1rem;
            font-weight: 400;
            margin-bottom: 0.25rem;
            line-height: 1.3;
            text-align: justify;
        }

        .description-details {
            font-family: 'Literata', serif;
            font-size: 0.9rem;
            font-weight: 400;
            line-height: 1.4;
            color: #000000;
        }

        /* === ПАНЕЛЬ УПРАВЛЕНИЯ === */
        .control-panel {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 1rem;
            z-index: 10;
        }

        .control-icons {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            align-items: flex-end;
            font-size: 1.1rem;
            line-height: 1.82rem;
        }

        .coordinate-text {
            font-family: 'Literata', serif;
            font-size: 0.8rem;
            text-align: right;
            color: #000000;
            line-height: 1.3;
        }

        /* === МУЗЫКАЛЬНЫЙ CANVAS === */
        .music-canvas-container {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 4;
            pointer-events: none;
        }

        #musicCanvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: auto;
        }

        .music-track {
            position: absolute;
            padding: 0px 2px;
            white-space: nowrap;
            cursor: pointer;
            font-family: 'Literata', serif;
            pointer-events: auto;
            transition: all 0.3s ease;
        }

        .music-track:hover {
            color: black !important;
            transform: scale(1.05);
        }

        .music-track.playing {
            font-weight: bold;
            padding: 1px 2px;
            background: rgb(255, 255, 255);
            border-color: black;
            border-style: solid;
            border-width: 1px 1px 1px 8px;
            z-index: 1000;
        }

        .music-track.playing:before {
            content: "\266B";
            color: black;
            margin-right: 4px;
        }

        .full-width-description {
            margin-bottom: 40px;
            margin-top: 20px;
        }

        .description-spacer {
            height: 200px;
        }

        .two-columns-container {
            display: flex;
            gap: 40px;
        }

        .description-column {
            flex: 1;
        }

        /* Адаптивность */
        @media (max-width: 768px) {
            .two-columns-container {
                flex-direction: column;
                gap: 20px;
            }
            
            .description-spacer {
                height: 30px;
            }
        }

        /* === АДАПТИВНЫЕ СТИЛИ === */

        /* Большие экраны (1200px+) */
        @media screen and (min-width: 1200px) {
            .descriptions {
                grid-template-columns: 1fr 1fr;
                gap: 2rem;
            }
            
            .container {
                padding: 2rem;
            }
        }

        /* Планшеты (768px - 1199px) */
        @media screen and (max-width: 1199px) {
            .main-content {
                margin-top: 70px;
            }
            
            .canvas-container {
                max-width: 90%;
            }
            
            .descriptions-content {
                width: 400px;
                max-height: 400px;
            }
        }

        /* Большие мобильные (601px - 767px) */
        @media screen and (max-width: 767px) {
            .header-navigation {
                padding: 0 0.5rem;
                gap: 0.5rem;
            }
            
            .nav-back {
                font-size: 0.9rem;
            }
            
            .nav-eye {
                font-size: 1.3rem;
            }
            
            .nav-about {
                font-size: 0.7rem;
            }
            
            .main-content {
                margin-top: 60px;
            }
            
            .canvas-container {
                max-width: 95%;
            }
            
            .descriptions-popup {
                bottom: 5rem;
                right: 1rem;
            }
            
            .descriptions-content {
                width: 350px;
                max-height: 350px;
                padding: 1rem;
            }
            
            .control-panel {
                bottom: 1rem;
                right: 1rem;
            }
            
            .coordinate-text {
                font-size: 0.7rem;
            }
        }

        /* Мобильные устройства (480px - 600px) */
        @media screen and (max-width: 600px) {
            .container {
                padding: 0.5rem;
            }
            
            .header-navigation {
                top: 0.5rem;
            }
            
            .main-content {
                margin-top: 50px;
            }
            
            .descriptions-toggle {
                width: 45px;
                height: 45px;
                font-size: 1.1rem;
            }
            
            .descriptions-content {
                width: 300px;
                max-height: 300px;
                bottom: 50px;
            }
            
            .descriptions {
                gap: 1rem;
            }
            
            .description-column {
                gap: 1rem;
            }
            
            .description-item {
                gap: 0.5rem;
            }
            
            .description-number {
                font-size: 0.9rem;
                min-width: 1.2rem;
            }
            
            .description-title {
                font-size: 0.9rem;
            }
            
            .description-details {
                font-size: 0.8rem;
            }
        }

        /* Маленькие мобильные (320px - 479px) */
        @media screen and (max-width: 479px) {
            .header-navigation {
                flex-wrap: wrap;
                padding: 0.5rem;
            }
            
            .nav-back, .nav-about {
                flex: 0 0 auto;
            }
            
            .nav-eye {
                flex: 0 0 100%;
                order: -1;
                margin-bottom: 0.5rem;
            }
            
            .main-content {
                margin-top: 80px;
            }
            
            .descriptions-popup {
                bottom: 4rem;
                right: 0.5rem;
            }
            
            .descriptions-content {
                width: 280px;
                max-height: 250px;
                right: -50px;
            }
            
            .control-panel {
                bottom: 0.5rem;
                right: 0.5rem;
            }
            
            .coordinate-text {
                font-size: 0.6rem;
                text-align: center;
            }
            
            .music-track {
                font-size: 0.9rem !important;
            }
        }

        /* Очень маленькие экраны (до 319px) */
        @media screen and (max-width: 319px) {
            .descriptions-content {
                width: 250px;
                max-height: 200px;
                padding: 0.8rem;
            }
            
            .description-item {
                flex-direction: column;
                gap: 0.25rem;
            }
            
            .description-number {
                min-width: auto;
            }
        }

        /* Альбомная ориентация на мобильных */
        @media screen and (max-height: 600px) and (orientation: landscape) {
            .main-content {
                margin-top: 50px;
            }
            
            .descriptions-content {
                max-height: 200px;
            }
            
            .header-navigation {
                padding: 0.25rem 0.5rem;
            }
        }

        /* Высокие экраны */
        @media screen and (min-height: 1000px) {
            .main-content {
                margin-top: 100px;
            }
            
            .canvas-container {
                max-width: 80%;
            }
        }

        /* Поддержка touch-устройств */
        @media (pointer: coarse) {
            .music-track {
                min-width: 44px;
                min-height: 44px;
                display: flex;
                align-items: center;
                justify-content: center;
            }
            
            .descriptions-toggle {
                min-width: 44px;
                min-height: 44px;
            }
            
            .nav-back, .nav-about {
                padding: 0.5rem;
                min-height: 44px;
                display: flex;
                align-items: center;
            }
        }
    </style>
</head>
<body>
    <div class="container" id="canvasContainer">
        <!-- Верхняя навигация -->
        <header class="header-navigation">
            <div class="nav-back" onclick="navigateToPage('map.html')">←</div>
            
            <div class="nav-about" onclick="navigateToPage('info.html')">О ПРОЕКТЕ</div>
        </header>

        <!-- Основная область с графическим элементом -->
        <main class="main-content">
            <div class="canvas-container">
                <div class="graphic-canvas" id="hiddenImage" style="display:none"></div>
                <canvas id="drawingCanvas"></canvas>
                
                <!-- Музыкальный canvas -->
                <div class="music-canvas-container">
                    <canvas id="musicCanvas"></canvas>
                </div>
            </div>
        </main>

            <!-- Всплывающая кнопка описаний -->
    <div class="descriptions-popup">
        <div class="descriptions-toggle" id="descriptionsToggle" title="Описания работ">
            i
        </div>
        <div class="descriptions-content" id="descriptionsContent">
            <div class="descriptions">
                <div class="description-fillwidth">
                    <!-- Полноширинное описание -->
                    <div class="full-width-description">
                        <div class="description-item">
                            <div class="description-number"></div>
                            <div class="description-content">
                                <div class="description-title">
                                    Walking with no other purpose than recording what happens. Humming to myself the thoughts of the day. Playing back recordings that I'd forgotten but needed to hear to remember how to dance. What happens in cities made of materials that play with each other. Containers of stories and hopefully voids for possible futures. Walking, sometimes looking for something. Walking, other times thinking about life, especially love. A soundmap of a place that we share and make everyday when we walk.
                                    <br><br>
                                    (to be noise and dance by María Alejandra Bulla)
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Промежуток -->
                    <div class="description-spacer"></div>

                    <!-- Двухколоночный список -->
                    <div class="two-columns-container">
                        <!-- Левая колонка -->
                        <div class="description-column">
                            <div class="description-item">
                                <div class="description-number">1</div>
                                <div class="description-content">
                                    <div class="description-title">Impossible Moments from Venice</div>
                                    <div class="description-details">2023<br>Natasha Barrett</div>
                                </div>
                            </div>

                            <div class="description-item">
                                <div class="description-number">2</div>
                                <div class="description-content">
                                    <div class="description-title">Aquaculture 18:00</div>
                                    <div class="description-details">2018<br>Jana Winderen</div>
                                </div>
                            </div>

                            <div class="description-item">
                                <div class="description-number">3</div>
                                <div class="description-content">
                                    <div class="description-title">Small Sand-stream On Beach</div>
                                    <div class="description-details">2008<br>Toshiya Tsunoda</div>
                                </div>
                            </div>

                            <div class="description-item">
                                <div class="description-number">4</div>
                                <div class="description-content">
                                    <div class="description-title">2</div>
                                    <div class="description-details">2014<br>Masayuki Imanishi</div>
                                </div>
                            </div>

                            <div class="description-item">
                                <div class="description-number">5</div>
                                <div class="description-content">
                                    <div class="description-title">Room With Sky</div>
                                    <div class="description-details">2004<br>John Hudak</div>
                                </div>
                            </div>

                            <div class="description-item">
                                <div class="description-number">6</div>
                                <div class="description-content">
                                    <div class="description-title">makers of cities, grains of sand that rain</div>
                                    <div class="description-details">2023<br>María Alejandra Bulla</div>
                                </div>
                            </div>

                            <div class="description-item">
                                <div class="description-number">7</div>
                                <div class="description-content">
                                    <div class="description-title">Gauzy Removal [Different Wind]</div>
                                    <div class="description-details">2023<br>Andrew Weathers</div>
                                </div>
                            </div>

                            <div class="description-item">
                                <div class="description-number">8</div>
                                <div class="description-content">
                                    <div class="description-title">Untitled 1</div>
                                    <div class="description-details">2007<br>Roel Meelkop</div>
                                </div>
                            </div>

                            <div class="description-item">
                                <div class="description-number">9</div>
                                <div class="description-content">
                                    <div class="description-title">Arrival</div>
                                    <div class="description-details">2016<br>Herbert Distel</div>
                                </div>
                            </div>
                        </div>

                        <!-- Правая колонка -->
                        <div class="description-column">
  
                            <div class="description-item">
                                <div class="description-number">10</div>
                                <div class="description-content">
                                    <div class="description-title">we'll come walking to find them</div>
                                    <div class="description-details">2023<br>María Alejandra Bulla</div>
                                </div>
                            </div>

                            <div class="description-item">
                                <div class="description-number">11</div>
                                <div class="description-content">
                                    <div class="description-title">Excerpt From Live Performance, West Seattle, WA</div>
                                    <div class="description-details">Aug. 19, 2001<br>Animist Orchestra</div>
                                </div>
                            </div>

                            <div class="description-item">
                                <div class="description-number">12</div>
                                <div class="description-content">
                                    <div class="description-title">Whisperers. Church</div>
                                    <div class="description-details">2009<br>Greta Hoheisel</div>
                                </div>
                            </div>

                            <div class="description-item">
                                <div class="description-number">13</div>
                                <div class="description-content">
                                    <div class="description-title">The Narrow Street</div>
                                    <div class="description-details">2017<br>Lieven Martens Moana</div>
                                </div>
                            </div>

                            <div class="description-item">
                                <div class="description-number">14</div>
                                <div class="description-content">
                                    <div class="description-title">Albuquerque Hotel Room</div>
                                    <div class="description-details">2006<br>Jeph Jerman</div>
                                </div>
                            </div>

                            <div class="description-item">
                                <div class="description-number">15</div>
                                <div class="description-content">
                                    <div class="description-title">Manhattan Sounds and Ambience</div>
                                    <div class="description-details">2017<br>City Sounds for Sleeping</div>
                                </div>
                            </div>

                            <div class="description-item">
                                <div class="description-number">16</div>
                                <div class="description-content">
                                    <div class="description-title">rhythm tappers, street walkers, song dancers</div>
                                    <div class="description-details">2023<br>María Alejandra Bulla</div>
                                </div>
                            </div>

                            <div class="description-item">
                                <div class="description-number">17</div>
                                <div class="description-content">
                                    <div class="description-title">A Time Spent (Anja)</div>
                                    <div class="description-details">2024<br>Arin Aksberg</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Панель управления -->
    <div class="control-panel">
        <div class="control-icons">
            <div class="coordinate-text">SCALE YOUR SCREEN<br> FIND THE RIGHT DISTANCE<br> CTRL + S FOR SAVE</div>
        </div>
    </div>

    <script>
        // Глобальные переменные для основного canvas
        let canvas, ctx;
        let currentTool = 'draw';
        let isDrawing = false;
        let startX, startY;
        let drawnObjects = [];
        let textNotes = [];
        let selectedObject = null;
        let isDragging = false;
        let dragOffset = { x: 0, y: 0 };

        // Глобальные переменные для музыкального canvas
        let musicCanvas, musicCtx;
        let musicTracks = [];
        let nowplaying = '';
        let audioPlayer = new Audio();
        let currentPlayingTrack = null;

        // Переменные для соединения треков
        let selectedTracks = [];
        let trackConnections = [];

        // Переменная для отслеживания состояния глаза
        let isEyeOpen = false;

        // Инициализация основного canvas
        function initCanvas() {
            canvas = document.getElementById('drawingCanvas');
            ctx = canvas.getContext('2d');
            
            // Устанавливаем размеры canvas
            resizeCanvas();
            
            // Настройки рисования
            ctx.strokeStyle = '#000000';
            ctx.lineWidth = 0.3;

            
            // Обработчики событий
            canvas.addEventListener('mousedown', handleMouseDown);
            canvas.addEventListener('mousemove', handleMouseMove);
            canvas.addEventListener('mouseup', handleMouseUp);
            canvas.addEventListener('dblclick', handleDoubleClick);
            
            // Обработчик изменения размера окна
            window.addEventListener('resize', resizeCanvas);
        }

        // Инициализация музыкального canvas
        function initMusicCanvas() {
            musicCanvas = document.getElementById('musicCanvas');
            musicCtx = musicCanvas.getContext('2d');
            
            // Устанавливаем размеры canvas
            resizeMusicCanvas();
            
            // Загружаем музыкальные треки
            loadMusicTracks();
            
            // Обработчик изменения размера окна
            window.addEventListener('resize', resizeMusicCanvas);
        }

        // Изменение размера основного canvas
        function resizeCanvas() {
            const container = canvas.parentElement;
            canvas.width = container.offsetWidth;
            canvas.height = container.offsetHeight;
            redrawAll();
        }

        // Изменение размера музыкального canvas
        function resizeMusicCanvas() {
            const container = musicCanvas.parentElement;
            musicCanvas.width = container.offsetWidth;
            musicCanvas.height = container.offsetHeight;
            drawTrackConnections();
        }

        // Загрузка музыкальных треков
        function loadMusicTracks() {
            // Данные треков из второго сайта
            musicTracks = [
                { id: 'item1', name: 'Impossible Moments from Venice ', color: '#000000', x: 900, y: 800, size: 130, previewUrl: "https://p.scdn.co/mp3-preview/f519412bfe7dc6d27429ded14854b414ba116b2d", spotifyId: '65bCrk05TVfkPuJYzC9MzZ' }, //Natasha Barrett Impossible Moments from Venice 
                { id: 'item2', name: 'Aquaculture 18:00', color: '#000000', x: 831, y: 2000, size: 180, previewUrl: 'https://p.scdn.co/mp3-preview/b3c3f55a6d0f547101c7a91c1cd17f40e62f7449', spotifyId: '24AJYq6020oRHs0SQ7S6rE' }, //title="e.g. Jana Winderen &quot;Aquaculture 18:00&quot;">
                
                { id: 'item3', name: 'Small Sand-stream On Beach', color: '#000000', x: 400, y: 300, size: 80, previewUrl: 'https://p.scdn.co/mp3-preview/120dc92994cee8a3451f4548b6165e95e2852b45', spotifyId: '12gShveX4cO8bHs99MPd56' }, // title="e.g. Toshiya Tsunoda &quot;Small Sand-stream On Beach
                { id: 'item4', name: '2', color: '#000000', x: 600, y: 200, size: 75, previewUrl: 'https://p.scdn.co/mp3-preview/bec2eb3b0d8d2a05bf3aa7e9a8766157e2c03a83', spotifyId: '2ACuU3FoySNlkPXQM5LF7K' }, //title="e.g. Masayuki Imanishi &quot;2&quot
                { id: 'item5', name: 'Room With Sky', color: '#000000', x: 300, y: 400, size: 70, previewUrl: 'https://p.scdn.co/mp3-preview/52ff5bb8a58d8691ee711885ffbc967d0e10b2b9', spotifyId: '5fU2kCzvkcXTMerGyLBFbC' }, //title="e.g. John Hudak &quot;Room With Sky&q
                { id: 'item6', name: 'makers of cities, grains of sand that rain', color: '#000000', x: 500, y: 500, size: 85, previewUrl: 'assets/1/08_María_Alejandra_Bulla_makers_of_cities,_grains_of_sand_that_rain.mp3' }, // title="e.g. Kim Cascone "4'39""
                
                { id: 'item8', name: 'we’ll come walking to find them', color: '#000000', x: 2600, y: 1200, size: 70, previewUrl: 'assets/1/04_María_Alejandra_Bulla_well_come_walking_to_find_them,_future.mp3' }, 
                { id: 'item9', name: 'Excerpt From Live Performance, Aug. 19, 2001, West Seattle, WA', color: '#000000', x: 2200, y: 1600, size: 60, previewUrl: 'https://p.scdn.co/mp3-preview/fb303790cb991ac8c0cb761bb1e6455e8d38ccd8', spotifyId: '58q4hWD1UgCF55x0xa8YVy' }, // title="e.g. Animist Orchestra "Excerpt From Live Performance, Aug. 19, 2001, West Seattle, WA""
                
                { id: 'item10', name: 'Whisperers. Church', color: '#000000', x: 1400, y: 1500, size: 85, previewUrl: 'https://p.scdn.co/mp3-preview/4c490cb8825b0eb1252bc6cad1cda8ca94681fa1', spotifyId: '5bTlTN8RzCtN43Z9iaRJTz' }, // title="e.g. Greta Hoheisel "Whisperers. Church""
                { id: 'item11', name: 'The Narrow Street', color: '#000000', x: 1600, y: 1400, size: 75, previewUrl: 'https://p.scdn.co/mp3-preview/ee3dedef7c6f173456cdeb002d8f6a5c228236f1', spotifyId: '6UqnrOe0qE6fS6lYHMqIVR' }, // title="e.g. Lieven Martens Moana "O Caminho - The Narrow Street""
                { id: 'item12', name: 'Albuquerque Hotel Room', color: '#000000', x: 1200, y: 1600, size: 70, previewUrl: 'https://p.scdn.co/mp3-preview/cfb0e0477a51c2bd97aea1fdbd26f451879a8a93', spotifyId: '3J6H6agNTZOD5jqxYef9w1' }, // title="e.g. Jeph Jerman "Albuquerque Hotel Room""
                
                { id: 'item13', name: 'Gauzy Removal', color: '#000000', x: 200, y: 1500, size: 65, previewUrl: 'assets/1/02 - Andrew Weathers - Gauzy Removal [Different Wind].mp3'},
                { id: 'item14', name: 'Untitled 1', color: '#000000', x: 2800, y: 300, size: 75, previewUrl: 'https://p.scdn.co/mp3-preview/186d9b5207fc55c69992bd1aa726f0a8901137de', spotifyId: '6zYzZOlwVJL4x6xEKYPgfS' }, // title="e.g. Roel Meelkop &quot;Untitled 1
                { id: 'item15', name: 'Arrival', color: '#000000', x: 400, y: 1600, size: 80, previewUrl: 'https://p.scdn.co/mp3-preview/82d27c3f2d04a2121c19da3f66dcb3fe851d7db0', spotifyId: '0rShZy06fPsklk5ZN3NjvX' }, //e.g. Herbert Distel "Arrival""
                { id: 'item16', name: 'Manhattan Sounds and Ambience, New York City', color: '#000000', x: 2600, y: 600, size: 70, previewUrl: 'https://p.scdn.co/mp3-preview/9659d999b5a0c6dcae477a9ab221cdbe148fc981', spotifyId: '52AGrErYdR5ObeZXcyCrPJ' }, // title="e.g. City Sounds for Sleeping "Manhattan Sounds and Ambience, New York City (feat. City Sounds Ambience)"
                { id: 'item17', name: 'rhythm tappers, street walkers, song dancers', color: '#000000', x: 2800, y: 900, size: 65, previewUrl: 'assets/1/06_María_Alejandra_Bulla_rhythm_tappers,_street_walkers,_song_dancers.mp3' }, 
                { id: 'item18', name: 'A Time Spent (Anja)', color: '#000000', x: 1800, y: 300, size: 70, previewUrl: 'assets/1/09 - Arin Aksberg - A Time Spent (Anja) [Nordic Patterns].mp3' }, 
               
            ];
            drawMusicTracks();
        }

        // Отрисовка музыкальных треков
        function drawMusicTracks() {
            // Очищаем canvas
            musicCtx.clearRect(0, 0, musicCanvas.width, musicCanvas.height);
            
            // Создаем DOM элементы для каждого трека
            const container = musicCanvas.parentElement;
            
            // Удаляем старые элементы
            const oldTracks = container.querySelectorAll('.music-track');
            oldTracks.forEach(track => track.remove());
            
            // Создаем новые элементы
            musicTracks.forEach(track => {
                const trackElement = document.createElement('div');
                trackElement.className = 'music-track';
                trackElement.id = track.id;
                trackElement.textContent = track.name;
                trackElement.style.color = track.color;
                trackElement.style.left = (track.x / 3000 * 100) + '%';
                trackElement.style.top = (track.y / 2000 * 100) + '%';
                trackElement.style.fontSize = (track.size / 100) + 'rem';
                
                // Добавляем lazy loading для аудио
                trackElement.setAttribute('data-preview-url', track.previewUrl);
                
                // Обработчик клика
                trackElement.addEventListener('click', () => handleTrackClick(track, trackElement));
                
                container.appendChild(trackElement);
            });
            
            // Отрисовываем соединения между треками
            drawTrackConnections();
        }

        function handleTrackClick(track, trackElement) {
            // Загружаем и воспроизводим трек только по требованию
            loadAndPlayTrack(track, trackElement);
            
            // Если это не первый выбранный трек, создаем связь с предыдущим
            if (selectedTracks.length > 0) {
                const previousTrack = selectedTracks[selectedTracks.length - 1];
                createTrackConnection(previousTrack, track);
            }
            
            // Добавляем трек в список выбранных
            selectedTracks.push(track);
            
            // Визуально выделяем выбранный трек
            trackElement.classList.add('selected');
        }
        
        // Функция для загрузки и воспроизведения трека по требованию
        function loadAndPlayTrack(track, trackElement) {
            if (nowplaying === track.name) {
                // Если трек уже играет, останавливаем его
                audioPlayer.pause();
                nowplaying = '';
                if (currentPlayingTrack) {
                    currentPlayingTrack.classList.remove('playing');
                }
            } else {
                // Останавливаем текущий трек
                audioPlayer.pause();
                if (currentPlayingTrack) {
                    currentPlayingTrack.classList.remove('playing');
                }
                
                // Загружаем и воспроизводим новый трек только при клике
                audioPlayer.src = track.previewUrl;
                audioPlayer.preload = 'none'; // Не загружать заранее
                audioPlayer.load(); // Принудительно загружаем только сейчас
                audioPlayer.play().catch(error => {
                    console.log('Автовоспроизведение заблокировано:', error);
                });
                nowplaying = track.name;
                
                // Подсвечиваем текущий трек
                trackElement.classList.add('playing');
                currentPlayingTrack = trackElement;
                
                // Автоматически снимаем выделение после окончания трека
                audioPlayer.onended = function() {
                    nowplaying = '';
                    if (currentPlayingTrack) {
                        currentPlayingTrack.classList.remove('playing');
                    }
                };
            }
        }

        // Создание соединения между треками
        function createTrackConnection(track1, track2) {
            // Проверяем, нет ли уже такого соединения
            const existingConnection = trackConnections.find(conn => 
                (conn.track1 === track1 && conn.track2 === track2) || 
                (conn.track1 === track2 && conn.track2 === track1)
            );
            
            if (!existingConnection) {
                // Добавляем новое соединение
                trackConnections.push({
                    track1: track1,
                    track2: track2,
                    color: '#000000',
                    width: 1
                });
                
                // Перерисовываем соединения
                drawTrackConnections();
            }
        }

        function drawTrackConnections() {
            // Очищаем canvas
            musicCtx.clearRect(0, 0, musicCanvas.width, musicCanvas.height);
            
            // Отрисовываем все соединения
            trackConnections.forEach(connection => {
                const track1 = connection.track1;
                const track2 = connection.track2;
                
                // Получаем координаты центров треков
                const x1 = (track1.x / 3000) * musicCanvas.width;
                const y1 = (track1.y / 2000) * musicCanvas.height;
                const x2 = (track2.x / 3000) * musicCanvas.width;
                const y2 = (track2.y / 2000) * musicCanvas.height;
                
                // Вычисляем вектор направления
                const dx = x2 - x1;
                const dy = y2 - y1;
                const length = Math.sqrt(dx * dx + dy * dy);
                
                // Нормализуем вектор
                const unitX = dx / length;
                const unitY = dy / length;
                
                // Укорачиваем линию на 20px с каждой стороны
                const shortenBy = 20;
                const startX = x1 + unitX * shortenBy;
                const startY = y1 + unitY * shortenBy;
                const endX = x2 - unitX * shortenBy;
                const endY = y2 - unitY * shortenBy;
                
                // Рисуем укороченную линию
                musicCtx.beginPath();
                musicCtx.moveTo(startX, startY);
                musicCtx.lineTo(endX, endY);
                musicCtx.strokeStyle = connection.color;
                musicCtx.lineWidth = connection.width;
                musicCtx.stroke();
            });
        }

        // Функция очистки всех связей
        function clearAllConnections() {
            trackConnections = [];
            selectedTracks = [];
            musicCtx.clearRect(0, 0, musicCanvas.width, musicCanvas.height);
            
            // Снимаем выделение со всех треков
            document.querySelectorAll('.music-track.selected').forEach(track => {
                track.classList.remove('selected');
            });
        }

        // Установка инструмента
        function setTool(tool) {
            currentTool = tool;
        }

        // Получение координат мыши относительно canvas
        function getMousePos(e) {
            const rect = canvas.getBoundingClientRect();
            return {
                x: e.clientX - rect.left,
                y: e.clientY - rect.top
            };
        }

        // Обработчик нажатия мыши
        function handleMouseDown(e) {
            // Реализация при необходимости
        }

        // Обработчик движения мыши
        function handleMouseMove(e) {
            // Реализация при необходимости
        }

        // Обработчик отпускания мыши
        function handleMouseUp(e) {
            // Реализация при необходимости
        }

        // Обработчик двойного клика для текстовых заметок
        function handleDoubleClick(e) {
            // Реализация при необходимости
        }

        // Поиск объекта в указанных координатах
        function findObjectAt(x, y) {
            for (let i = drawnObjects.length - 1; i >= 0; i--) {
                const obj = drawnObjects[i];
                if (obj.type !== 'freehand' && 
                    x >= obj.x && x <= obj.x + obj.width &&
                    y >= obj.y && y <= obj.y + obj.height) {
                    return obj;
                }
            }
            return null;
        }

        // Перерисовка всех объектов
        function redrawAll() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // Восстанавливаем настройки
            ctx.strokeStyle = '#000000';
            ctx.lineWidth = 1;
            ctx.lineCap = 'round';
            ctx.lineJoin = 'round';
            ctx.setLineDash([]);
            
            // Рисуем все сохраненные объекты
            drawnObjects.forEach(obj => {
                switch(obj.type) {
                    case 'freehand':
                        ctx.putImageData(obj.imageData, 0, 0);
                        break;
                }
            });
        }

        // Очистка холста
        function clearCanvas() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            drawnObjects = [];
            
            // Удаляем все текстовые заметки
            textNotes.forEach(note => {
                if (note.element && note.element.parentNode) {
                    note.element.parentNode.removeChild(note.element);
                }
            });
            textNotes = [];
        }

        // Переключение изображения с анимацией глаза
        function toggleImage() {
            const image = document.getElementById('hiddenImage');
            const eyeButton = document.getElementById('imageToggle');
            
            if (image.style.display === 'none') {
                image.style.display = 'block';
                eyeButton.textContent = '⚆'; // Открытый глаз
                isEyeOpen = true;
            } else {
                image.style.display = 'none';
                eyeButton.textContent = '◠'; // Закрытый глаз
                isEyeOpen = false;
            }
        }

        // Навигация
        function navigateToPage(page) {
            window.location.href = page;
        }

        // Функция для переключения описаний
        function toggleDescriptions() {
            const toggle = document.getElementById('descriptionsToggle');
            const content = document.getElementById('descriptionsContent');
            
            toggle.classList.toggle('active');
            content.classList.toggle('active');
        }

        // Закрытие описаний при клике вне области
        document.addEventListener('click', function(event) {
            const toggle = document.getElementById('descriptionsToggle');
            const content = document.getElementById('descriptionsContent');
            
            if (!toggle.contains(event.target) && !content.contains(event.target)) {
                toggle.classList.remove('active');
                content.classList.remove('active');
            }
        });

        // Инициализация при загрузке страницы
        window.addEventListener('load', function() {
            initCanvas();
            initMusicCanvas();
            
            // Добавляем обработчик для кнопки описаний
            document.getElementById('descriptionsToggle').addEventListener('click', toggleDescriptions);
            
            // Предзагрузка только первых 2 треков для ускорения начальной загрузки
            preloadFirstTracks(2);
        });

        // Функция для предзагрузки только первых N треков
        function preloadFirstTracks(count) {
            for (let i = 0; i < Math.min(count, musicTracks.length); i++) {
                const track = musicTracks[i];
                // Предзагружаем только Spotify треки (они маленькие)
                if (track.previewUrl.includes('p.scdn.co')) {
                    const preloadAudio = new Audio();
                    preloadAudio.src = track.previewUrl;
                    preloadAudio.preload = 'metadata'; // Только метаданные, не весь файл
                }
            }
        }
        
    </script>
    
</body>
</html>